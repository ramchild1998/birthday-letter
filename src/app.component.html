<!-- Background Scene -->
<div class="relative w-full h-full flex flex-col items-center justify-center bg-[url('https://images.unsplash.com/photo-1533616688419-0e918c99a353?q=80&w=2574&auto=format&fit=crop')] bg-cover bg-center overflow-hidden">
  <!-- Dark overlay for legibility -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

  <!-- Audio Element (Hidden) -->
  <audio #audioPlayer loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/10/25/audio_5145eb5b0a.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <!-- Main Animation Stage -->
  <div class="relative z-10 w-full h-full flex items-center justify-center perspective-1000">

    <!-- The Letter (Appears in the center) -->
    <!-- Dynamic Z-index: z-50 when open to ensure it sits ON TOP of the envelope -->
    <div 
      class="absolute w-[90%] max-w-md md:max-w-lg bg-[#f9f5eb] shadow-2xl p-6 md:p-12 text-left transition-all duration-700 ease-in-out origin-center"
      (click)="toggleLetter()"
      [class.z-20]="!isOpen()"
      [class.z-50]="isOpen()"
      [class.opacity-0]="!isOpen()"
      [class.animate-unfold]="isOpen()"
      [class.pointer-events-none]="!isOpen()"
    >
      <!-- Paper Texture Overlay -->
      <div class="absolute inset-0 opacity-50 pointer-events-none mix-blend-multiply bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')]"></div>

      <!-- Content -->
      <div class="relative z-20 overflow-y-auto max-h-[60vh] md:max-h-[70vh] scrollbar-hide w-full">
        <div class="flex justify-between items-start mb-4 md:mb-6">
            <div>
              <h2 class="font-['Playfair_Display'] text-xl md:text-3xl font-bold text-[#8b0000] mb-1 md:mb-2 text-shadow">Happy Birthday</h2>
              <h3 class="font-['Playfair_Display'] text-lg md:text-2xl text-gray-800 text-shadow">{{ recipientName() }}</h3>
            </div>
            <p class="font-['Playfair_Display'] text-xs md:text-sm text-gray-500 pt-2">{{ date() }}</p>
        </div>
        
        <!-- Dancing Script font for legibility -->
        <p class="font-['Dancing_Script'] text-xl md:text-3xl text-gray-800 leading-relaxed mb-6 md:mb-8 min-h-[4rem] font-medium">
          {{ displayedMessage() }}
          @if (isWriting()) {
            <span class="inline-block w-[2px] h-[1em] bg-gray-600 ml-1 animate-pulse align-baseline"></span>
          }
        </p>

        <div class="mt-6 md:mt-8 font-['Playfair_Display'] text-sm md:text-md text-gray-600">
          <p>With all my love, always,</p>
          <p class="font-['Monsieur_La_Doulaise'] text-[#8b0000] text-4xl md:text-5xl mt-2 -rotate-2 origin-left opacity-90 pb-2">{{ senderName() }}</p>
        </div>
      </div>

      <!-- Edit Button (Small icon) -->
      <button 
        (click)="openEditModal($event)"
        class="absolute bottom-4 right-4 text-gray-400 hover:text-[#8b0000] transition-colors p-1 z-30"
        title="Personalize Message"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      </button>
    </div>

    <!-- The Envelope Component -->
    <!-- Mobile: Slides UP (-translate-y-35vh) | Desktop: Slides LEFT (-translate-x) -->
    <div 
      class="absolute z-30 w-[300px] h-[200px] md:w-[400px] md:h-[280px] transition-all duration-1000 ease-in-out cursor-pointer transform-gpu"
      (click)="toggleLetter()"
      [class.-translate-y-[35vh]]="isOpen()" 
      [class.md:translate-y-0]="isOpen()"
      [class.md:-translate-x-[350px]]="isOpen()"
      [class.opacity-50]="isOpen()"
      [class.scale-75]="isOpen()"
      [class.md:scale-90]="isOpen()"
    >
      <!-- Envelope Body (Front) -->
      <div class="absolute inset-0 bg-[#8b0000] z-20 shadow-2xl rounded-b-lg border-2 border-[#6d0000] flex items-end justify-center overflow-hidden">
         <div class="absolute top-0 w-0 h-0 border-l-[150px] md:border-l-[200px] border-r-[150px] md:border-r-[200px] border-b-[130px] md:border-b-[180px] border-l-transparent border-r-transparent border-b-[#9e0000]"></div>
         <div class="absolute bottom-16 md:bottom-20 z-30 w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-yellow-500 to-yellow-700 rounded-full shadow-lg flex items-center justify-center border-2 border-yellow-400/50">
            <span class="font-['Great_Vibes'] text-lg md:text-xl text-yellow-100 font-bold text-shadow-sm">R</span>
         </div>
      </div>
      <!-- Envelope Flap (Top) -->
      <div 
        class="absolute top-0 left-0 right-0 h-1/2 z-30 origin-top transform-style-3d transition-custom"
        [class.rotate-x-180]="isOpen()"
      >
        <div class="w-0 h-0 border-l-[150px] md:border-l-[200px] border-r-[150px] md:border-r-[200px] border-t-[100px] md:border-t-[140px] border-l-transparent border-r-transparent border-t-[#b22222] drop-shadow-md"></div>
      </div>
    </div>

    <!-- Photo Frame -->
    <!-- Mobile: Slides DOWN (translate-y-35vh) | Desktop: Slides RIGHT (translate-x) -->
    <div 
      class="absolute z-10 w-[240px] h-[300px] md:w-[280px] md:h-[350px] bg-gradient-to-br from-[#d4af37] to-[#b8860b] p-3 md:p-4 shadow-2xl rounded-sm transform transition-all duration-1000 ease-in-out origin-bottom-left transform-gpu"
      [class.opacity-0]="!isOpen()"
      [class.pointer-events-none]="!isOpen()"
      [class.opacity-100]="isOpen()"
      [class.translate-y-[35vh]]="isOpen()"
      [class.md:translate-y-0]="isOpen()"
      [class.md:translate-x-[350px]]="isOpen()"
      [class.rotate-6]="isOpen()"
    >
        <div class="w-full h-full bg-white border-2 border-[#b8860b] shadow-inner p-2 flex flex-col gap-2">
             <!-- Photo Container (Non-clickable now) -->
             <div class="w-full h-[85%] overflow-hidden relative">
               <img [src]="photoUrl()" alt="Photo of us" class="w-full h-full object-cover grayscale opacity-90">
            </div>
            <div class="h-[15%] flex items-center justify-center">
                <p class="font-['Great_Vibes'] text-xl md:text-2xl text-gray-700">Forever Us</p>
            </div>
        </div>
        <div class="absolute inset-0 bg-gradient-to-tr from-white/20 to-transparent pointer-events-none rounded-sm"></div>
    </div>
  </div>
  
  <!-- Hidden File Input for Photo Upload (Accessed via Modal) -->
  <input 
    #fileInput 
    type="file" 
    class="hidden" 
    accept="image/*" 
    (change)="handlePhotoUpload($event)"
  >

  <!-- Music Toggle (if opened) -->
  @if (isOpen()) {
    <div class="absolute top-4 right-4 z-50">
      <button (click)="isPlaying() ? pauseMusic() : playMusic()" class="bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-full p-3 text-white transition-colors border border-white/30">
        @if (isPlaying()) {
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        }
      </button>
    </div>
  }

  <!-- Edit/Personalize Modal -->
  @if (showEditModal()) {
    <div class="fixed inset-0 z-[60] flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" (click)="closeEditModal()"></div>
      <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md relative z-10 animate-fade-in-up">
        <h3 class="font-['Playfair_Display'] text-2xl font-bold text-[#8b0000] mb-4">Personalize Letter</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">Our Photo</label>
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded overflow-hidden border border-gray-300">
                <img [src]="photoUrl()" class="w-full h-full object-cover">
              </div>
              <button 
                (click)="triggerFileUpload()"
                class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded border border-gray-300 transition-colors"
              >
                Change Photo
              </button>
            </div>
             <p class="text-xs text-gray-500 mt-1">Photo is saved on this device (LocalStorage).</p>
          </div>
          <hr class="border-gray-100 my-2">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">Recipient Name</label>
            <input 
              type="text" 
              [value]="recipientName()" 
              (input)="recipientName.set($any($event).target.value)"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#8b0000] focus:border-[#8b0000] font-['Lato']"
            >
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">Relationship Context</label>
            <input 
              type="text" 
              [value]="editRelationship()"
              (input)="editRelationship.set($any($event).target.value)"
              placeholder="e.g. My beautiful wife, My secret crush"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#8b0000] focus:border-[#8b0000] font-['Lato']"
            >
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-1">Tone / Vibe</label>
            <select 
              [value]="editTone()"
              (change)="editTone.set($any($event).target.value)"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#8b0000] focus:border-[#8b0000] bg-white font-['Lato']"
            >
              <option value="Romantic & Deep">Romantic & Deep</option>
              <option value="Lighthearted & Sweet">Lighthearted & Sweet</option>
              <option value="Poetic & Classic">Poetic & Classic</option>
              <option value="Short & Punchy">Short & Punchy</option>
            </select>
          </div>
          <div class="pt-4 flex justify-end gap-3">
            <button (click)="closeEditModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 rounded-md">Cancel</button>
            <button 
              (click)="generateNewMessage()" 
              [disabled]="isGenerating()"
              class="px-6 py-2 bg-[#8b0000] text-white rounded-md hover:bg-[#6d0000] disabled:opacity-50 flex items-center gap-2 transition-colors"
            >
              @if (isGenerating()) {
                <span class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                Writing...
              } @else {
                <span>Generate with AI âœ¨</span>
              }
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>